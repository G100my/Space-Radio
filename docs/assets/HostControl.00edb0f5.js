import{m as e,a as t,r as i}from"./index.174e8da4.js";import{o as s,c as l,a as o,h as n,v as a}from"./vendor.074003e4.js";const r={data:()=>({player:null,deviceId:null,playerVolume:50,deviceActived:!1,paused:!0,positionStateCounter:0,coundDownTimer:null,utterance:new window.SpeechSynthesisUtterance,recodeVolume:null,executeBeforeEndTime:1e4,adjustProcessTime:5e3,adjustStepTime:100,dislikeThreshold:2,dislikeCountdownTimer:null,minimalVolume:50,minimalVolumeDeferTimer:null,isShowMinimalControlBoard:!1}),computed:(0,Object.assign)({adjustExecuteTimes(){return this.adjustProcessTime/this.adjustStepTime}},e(["playerPlayingTrackId","currentVolume","currentMinimalVolume","currentDislike","currentDislikeThreshold","trackData","pendingQueue","leftQueueAmount","token","isTokenValid"])),watch:{pendingQueue(e){if(e&&e.note){const i=e.note,s=t(i,e.track_name);this.$store.dispatch("updateTheLatestQueue",e),this.reducePlayerVolume().then((()=>{this.TTS(s)})).catch((e=>{console.error(e)}))}},currentDislike(e){if(this.dislikeCountdownTimer&&e<this.dislikeThreshold&&(clearTimeout(this.dislikeCountdownTimer),this.dislikeCountdownTimer=null),e>=this.dislikeThreshold){let e=10;this.dislikeCountdownTimer=setInterval((()=>{e-=1,this.$store.dispatch("updateDislikeCountdown",e),console.log(e),e<=0&&(this.nextTrack(),clearInterval(this.dislikeCountdownTimer),this.$store.dispatch("clearDislikeVote"),this.$store.dispatch("updateDislikeCountdown",!1),this.dislikeCountdownTimer=null)}),1e3)}}},created(){window.onbeforeunload=()=>{this.$store.dispatch("clearPlayingTrack"),this.$store.dispatch("clearPendingQueue"),this.deviceActived&&this.player.disconnect()},window.onSpotifyWebPlaybackSDKReady=()=>{this.player=new window.Spotify.Player({name:"Jukebox player",volume:this.currentVolume/100,getOAuthToken:e=>{this.isTokenValid?e(this.token):i().then((()=>{e(this.token)}))}});["initialization_error","account_error","playback_error","authentication_error","not_ready"].forEach((e=>{this.player.addListener(e,(t=>{console.log(e,t)}))})),this.player.addListener("ready",(({device_id:e})=>{console.log("Ready with Device ID",e),this.deviceId=e,this.$spotifyAPI.transferMyPlayback([this.deviceId],{play:!0},(e=>{e&&console.log(e.response),e||(this.deviceActived=!0)})),this.$watch("currentVolume",(e=>{console.log("currentVolume"),this.playerVolume=e,console.log(this.player),null!==this.player&&this.player.setVolume(e/100)}))}));const e=t=>{this.pendingQueue&&t.track_window.next_tracks[0].id!==this.pendingQueue.id&&this.$store.dispatch("clearPendingQueue"),this.player.removeListener("player_state_changed",e)};this.player.addListener("player_state_changed",e),this.player.addListener("player_state_changed",(e=>{if(console.log(e),null===e)return this.deviceActived=!1,this.paused=!0,void this.$store.dispatch("clearPlayingTrack");this.paused=e.paused;const t=e.track_window.current_track.id;if(t!==this.playerPlayingTrackId){const t=e.track_window.current_track;this.$store.dispatch("updatePlayingTrack",t)}if(0===e.position&&(this.positionStateCounter++,this.positionStateCounter>=2&&(this.positionStateCounter=0,this.pendingQueue&&this.pendingQueue.id===t&&this.$store.dispatch("clearPendingQueue"))),!e.paused&&this.leftQueueAmount>0&&!this.pendingQueue){const t=5*Math.floor(5*Math.random())*1e3,i=e.duration-e.position-this.executeBeforeEndTime-t;i>0&&(this.coundDownTimer&&clearTimeout(this.coundDownTimer),console.log("set coundDownTimer"),this.coundDownTimer=setTimeout((()=>{this.$store.dispatch("sendNextQueue")}),i))}}))};const e=document.createElement("script");e.defer=!0,e.async=!0,document.head.appendChild(e),e.src="https://sdk.scdn.co/spotify-player.js",this.utterance.pitch=1,this.utterance.rate=1,this.utterance.volume=1,this.utterance.lang="zh-TW",this.utterance.onerror=e=>{console.log("utterance error",e),this.resumePlayerVolume()},this.utterance.onend=()=>{console.log("utterance end"),this.resumePlayerVolume()},speechSynthesis.onvoiceschanged=()=>{this.utterance.voice||this.setTTSVoice()}},methods:{setTTSVoice(){const e=speechSynthesis.getVoices().find((e=>e.name.includes("Google")&&e.lang.includes("zh-TW")));null!==e&&(this.utterance.voice=e)},TTS(e){null===this.utterance.voice&&this.setTTSVoice(),this.utterance.text=e,speechSynthesis.speak(this.utterance)},reducePlayerVolume(){return new Promise((e=>{this.recodeVolume=this.playerVolume;const t=(this.playerVolume-this.currentMinimalVolume)/this.adjustExecuteTimes,i=setInterval((()=>{const s=this.playerVolume-t;if(this.player.setVolume(s/100),s<this.currentMinimalVolume)return clearInterval(i),void e();this.playerVolume=s}),this.adjustStepTime)}))},resumePlayerVolume(){return new Promise((e=>{const t=(this.recodeVolume-this.playerVolume)/this.adjustExecuteTimes,i=setInterval((()=>{const s=this.playerVolume+t;if(this.player.setVolume(s/100),s>this.recodeVolume)return clearInterval(i),this.playerVolume=this.recodeVolume,this.recodeVolume=null,void e();this.playerVolume=s}),this.adjustStepTime)}))},nextTrack(){const e=this.minimalVolume,t=this.adjustProcessTime;this.minimalVolume=0,this.adjustProcessTime=3e3;let i=0;const s=({position:l})=>{0===l&&i++,i>=2&&(this.player.removeListener("player_state_changed",s),this.resumePlayerVolume().then((()=>{this.minimalVolume=e,this.adjustProcessTime=t})).catch((e=>console.error(e))))};this.reducePlayerVolume().then((()=>{this.$store.dispatch("sendNextQueue",(()=>{this.player.nextTrack("just wanna listen next one").then((()=>{console.log("Skipped to next track!"),this.player.addListener("player_state_changed",s)})).catch((e=>console.error(e)))}))}))},togglePlay(){this.player.togglePlay(this.deviceId).then((()=>console.log("toggle play")))},submitHandler(){const e=Number.parseInt(this.$refs.minimalVolumeInput.value);this.minimalVolume!==e&&(this.minimalVolume=e,this.$store.dispatch("updateMinimalVolume",this.minimalVolume));const t=Number.parseInt(this.$refs.dislikeThresholdInput.value);this.dislikeThreshold!==t&&(this.dislikeThreshold=t,this.$store.dispatch("updateDislikeThreshold",this.dislikeThreshold))},resetHandler(){this.$refs.minimalVolumeInput.value=this.minimalVolume,this.$refs.dislikeThresholdInput.value=this.dislikeThreshold}}},u={class:"main-control"},c={xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",class:"bi bi-play-fill",viewBox:"0 0 16 16"},h=o("path",{d:"M11.596 8.697l-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"},null,-1),d={xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",class:"bi bi-pause-fill",viewBox:"0 0 16 16"},m=o("path",{d:"M5.5 3.5A1.5 1.5 0 0 1 7 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5zm5 0A1.5 1.5 0 0 1 12 5v6a1.5 1.5 0 0 1-3 0V5a1.5 1.5 0 0 1 1.5-1.5z"},null,-1),p=o("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"currentColor",class:"bi bi-gear",viewBox:"0 0 16 16"},[o("path",{d:"M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"}),o("path",{d:"M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"})],-1),y={class:"minimal-control"},T=o("span",null,"Minimal volume:",-1),v=o("span",null,"Dislike vote threshold:",-1),k={class:"buttons"};r.render=function(e,t,i,r,g,V){return s(),l("div",u,[o("button",{class:"play-button",type:"button",onClick:t[1]||(t[1]=e=>(!g.deviceActived&&g.player.connect(),g.deviceActived&&V.togglePlay(e)))},[n((s(),l("svg",c,[h],512)),[[a,g.paused]]),n((s(),l("svg",d,[m],512)),[[a,!g.paused]])]),o("button",{class:["setting-button",{active:g.isShowMinimalControlBoard}],type:"button",onClick:t[2]||(t[2]=e=>g.isShowMinimalControlBoard=!g.isShowMinimalControlBoard)},[p],2),n(o("div",y,[o("p",null,[T,o("input",{ref:"minimalVolumeInput",value:e.currentMinimalVolume,type:"number",step:"2",min:"10",max:"50"},null,8,["value"])]),o("p",null,[v,o("input",{ref:"dislikeThresholdInput",value:e.currentDislikeThreshold,type:"number",min:"2",max:"5"},null,8,["value"])]),o("div",k,[o("button",{type:"button",onClick:t[3]||(t[3]=(...e)=>V.submitHandler&&V.submitHandler(...e))},"submit"),o("button",{type:"button",onClick:t[4]||(t[4]=(...e)=>V.resetHandler&&V.resetHandler(...e))},"reset")])],512),[[a,g.isShowMinimalControlBoard]])])};export default r;
